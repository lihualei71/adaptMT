load("../data/estrogen.RData")
pvals <- as.numeric(estrogen$pvals)
x <- data.frame(x = as.numeric(estrogen$ord))
n <- length(pvals)
s <- rep(0.45, n)
dist <- beta_family()
piargs <- muargs <- list(formula = ~ ns(x, df = 8))

source("../R/source_all.R")
source("../R/adapt_model.R")

mod <- gen_adapt_model_glm(beta_family(), list(formula = "ns(x, df = 8)"), list(formula = "ns(x, df = 8)"))

init_obj <- init_mix(x, pvals, s, dist,
                     mod$algo$pifun_init, mod$algo$mufun_init,
                     mod$args$piargs_init, muargs = mod$args$muargs_init)

summary(init_obj$pix, digits = 10)
## c(0, 0.07884513, 0.1194709, 0.1340804, 0.179624, 0.586203)
summary(init_obj$mux, digits = 10)
## c(1.763264, 1.769205, 1.776525, 1.852323, 1.831987, 2.987274)
Estep_obj <- Estep_mix(pvals, s, dist, init_obj$pix, init_obj$mux)
summary(Estep_obj$Hhat, digits = 10)
## c(0, 0.07178834, 0.1149031, 0.1375873, 0.1699528, 0.9960277)
summary(Estep_obj$phat, digits = 10)
## c(1.104524e-05, 0.1757817, 0.3478994, 0.311381, 0.4583199, 0.5499793)
Mstep_obj <- Mstep_mix(x, Estep_obj$Hhat, Estep_obj$phat, dist,
                       mod$algo$pifun, mod$algo$mufun,
                       mod$args$piargs, mod$args$muargs)
summary(Mstep_obj$pix, digits = 10)
## c(0.01730374, 0.07845116, 0.1176432, 0.1375873, 0.1749168, 0.7361001)
summary(Mstep_obj$mux, digits = 10)
## c(1.657742, 1.693265, 1.739558, 1.841315, 1.770693, 3.19766)


mod <- list(name = "glm", args = list(piargs = list(formula = "ns(x, df = 8)"), muargs = list(formula = "ns(x, df = 8)")))
EM_obj <- EM_mix(x, pvals, s, dist, mod)
mod2 <- gen_adapt_model_glm(beta_family(), list(formula = "ns(x, df = 8)"), list(formula = "ns(x, df = 8)"))
EM_obj2 <- EM_mix(x, pvals, s, dist, mod2)
identical(EM_obj, EM_obj2)

mods <- lapply(6:15, function(i){
    formula <- paste0("ns(x, df = ", i, ")")
    structure(list(name = "glm",
                   args = list(piargs = list(formula = formula),
                       muargs = list(formula = formula))),
                   class = "adapt_model")
})
EM_ms_obj <- EM_mix_ms(x, pvals, s, dist, mods)
mods2 <- lapply(6:15, function(i){
    formula <- paste0("ns(x, df = ", i, ")")
    gen_adapt_model_glm(dist,
         list(formula = formula), list(formula = formula))
})
EM_ms_obj2 <- EM_mix_ms(x, pvals, s, dist, mods2)
identical(EM_ms_obj$params, EM_ms_obj2$params)


res <- adapt(x, pvals, mods, dist)
res2 <- adapt(x, pvals, mods2, dist)
identical(res$s, res2$s)

x1 <- x[1:5000,,drop=FALSE]
pvals1 <- pvals[1:5000]
res <- adapt(x[1:5000,,drop=FALSE], pvals[1:5000], mods[1:5], dist)

tmp1 <- EM_mix(x[1:2000,,drop=FALSE], pvals[1:2000], s[1:2000], dist, mods[[1]])
tmp <- EM_mix(x, pvals, s, dist, mods[[1]])
